"use strict";(function(){var s;var p,l,i,c,f,y,h;var q;var a=null;var g=null;var o=new RpcWsClient("wss://nodes.creary.net");o.connect();o.on("ws.message",function(z,A){console.log("WS MSG",z,A)});function t(){if(!s){s=new Vue({el:"#market-container",data:{lang:lang,session:a,account:g,recentTrades:[],ticker:{penultimate:null,latest:"0.000000",lowest_ask:"0.000000",highest_bid:"0.000000",percent_change:"0.000000",crea_volume:"0.000 CREA",cbd_volume:"0.000 CREA"},buyForm:{price:"0.000",amount:"0.000",total:"0.000"},sellForm:{price:"0.000",amount:"0.000",total:"0.000"}},methods:{parseAsset:Asset.parse,dateFromNow:function(z){return moment(toLocaleDate(z)).fromNow()},priceFor:function(D,A){var z=Asset.parse(D);var B=Asset.parse(A);var C=B.toFloat()/z.toFloat();return Asset.parse({amount:C,nai:B.asset.symbol})},clearOrderForm:function(z){z=z.toLowerCase();if(z==="buy"){this.buyForm.price="0.000";this.buyForm.amount="0.000";this.buyForm.total="0.000"}else{this.sellForm.price="0.000";this.sellForm.amount="0.000";this.sellForm.total="0.000"}},onParseBuyForm:function(){this.buyForm.price=Asset.parse({amount:this.buyForm.price?parseFloat(this.buyForm.price)+0.0001:"0.000",nai:"cbd"}).toPlainString();this.buyForm.amount=Asset.parse({amount:this.buyForm.amount?parseFloat(this.buyForm.amount)+0.0001:"0.000",nai:"cbd"}).toPlainString();if(!isNaN(this.buyForm.price)&&!isNaN(this.buyForm.amount)){this.buyForm.total=Asset.parse({amount:parseFloat(this.buyForm.price*this.buyForm.amount)+0.0001,nai:"cbd"}).toPlainString()}else{this.buyForm.total=Asset.parse({amount:parseFloat(this.buyForm.total)+0.0001,nai:"cbd"}).toPlainString()}},inputBuy:function(z,D){D=D.toLowerCase();var F=(z.which)?z.which:z.keyCode;if((F>31&&(F<48||F>57))&&F!==46){cancelEventPropagation(z);return false}var E=z.target.value;var H=Asset.parse({amount:E,nai:"crea",exponent:3}).toPlainString();if(!isNaN(E)||!isNaN(H)){var B=this.buyForm.amount;switch(D){case"price":if(B){var G=(B*H).toString();this.buyForm.total=Asset.parse({amount:G,nai:"cbd",exponent:3}).toPlainString()}break;case"amount":var C=this.buyForm.price;if(C){var G=(H*C).toString();this.buyForm.total=Asset.parse({amount:G,nai:"cbd",exponent:3}).toPlainString()}break;default:if(B){var A=(H/B).toString();this.buyForm.price=Asset.parse({amount:A,nai:"cbd",exponent:3}).toPlainString()}}}return true},onParseSellForm:function(){this.sellForm.price=Asset.parse({amount:this.sellForm.price?parseFloat(this.sellForm.price)+0.0001:"0.000",nai:"cbd"}).toPlainString();this.sellForm.amount=Asset.parse({amount:this.sellForm.amount?parseFloat(this.sellForm.amount)+0.0001:"0.000",nai:"cbd"}).toPlainString();if(!isNaN(this.sellForm.price)&&!isNaN(this.sellForm.amount)){this.sellForm.total=Asset.parse({amount:parseFloat(this.sellForm.price*this.sellForm.amount)+0.0001,nai:"cbd"}).toPlainString()}else{this.sellForm.total=Asset.parse({amount:parseFloat(this.sellForm.total)+0.0001,nai:"cbd"}).toPlainString()}},inputSell:function(z,D){D=D.toLowerCase();var F=(z.which)?z.which:z.keyCode;if((F>31&&(F<48||F>57))&&F!==46){cancelEventPropagation(z);return false}var E=z.target.value;var H=Asset.parse({amount:E,nai:"crea",exponent:3}).toPlainString();if(!isNaN(E)||!isNaN(H)){var B=this.sellForm.amount;switch(D){case"price":if(B){var G=(B*E).toString();this.sellForm.total=Asset.parse({amount:G,nai:"cbd",exponent:3}).toPlainString()}break;case"amount":var C=this.sellForm.price;if(C){var G=(E*C).toString();this.sellForm.total=Asset.parse({amount:G,nai:"cbd",exponent:3}).toPlainString()}break;default:if(B){var A=(E/B).toString();this.sellForm.price=Asset.parse({amount:A,nai:"cbd",exponent:3}).toPlainString()}}}return true},makeOrder:function(z){z=z.toLowerCase();var A=this;var B=a?a.account.username:null;requireRoleKey(B,"active",function(I,H){var G,F,D,C;var E=new Date();D=new Date(E.getTime()+(60*60*24*27*1000));C=randomNumber(0,4294967295);if(z==="buy"){G=A.buyForm.total+" CBD";F=A.buyForm.amount+" CREA"}else{if(z==="sell"){G=A.sellForm.amount+" CREA";F=A.sellForm.total+" CBD"}}crea.broadcast.limitOrderCreate(I,H,C,G,F,false,D,function(K,J){if(!catchError(K)){A.clearOrderForm(z);w();updateUserSession()}})})}}})}else{s.session=a;s.account=g;s.$forceUpdate()}}function x(z,A){A=A.toLowerCase();if(A==="buy"){s.buyForm.price=z.price;s.buyForm.amount=z.crea;s.onParseBuyForm()}else{s.sellForm.price=z.price;s.sellForm.amount=z.crea;s.onParseSellForm()}}function v(z){requireRoleKey(a.account.username,"active",function(A){crea.broadcast.limitOrderCancel(A,a.account.username,z,function(C,B){if(!catchError(C)){w();updateUserSession()}})})}function w(){if(a){var z={method:"condenser_api.get_open_orders",params:[a.account.username]};o.send(z,function(C,A){if(!catchError(C)){var B=function(E){var H=Asset.parse(E.sell_price.base);var G=Asset.parse(E.sell_price.quote);var F=H.asset.symbol==="CREA"?"Sell":"Buy";return{date:moment(E.created).format("MMM DD, YYYY H:mm:ss"),expiration:moment(E.expiration).format("MMM DD, YYYY H:mm:ss"),type:F,price:"$"+Asset.parse({amount:(F==="Buy"?H.toFloat()/G.toFloat():G.toFloat()/H.toFloat())+0.0001,nai:"cbd"}).toPlainString(),crea:F==="Buy"?G.toFriendlyString():Asset.parse({amount:E.for_sale,nai:"crea"}).toFriendlyString(),cbd:F==="Buy"?Asset.parse({amount:E.for_sale,nai:"cbd"}).toFriendlyString():G.toFriendlyString(),action:"button",orderid:E.orderid}};var D=[];A.forEach(function(E){D.push(B(E))});D.sort(function(F,E){return new Date(E.date).getTime()-new Date(F.date).getTime()});y.clear();y.rows.add(D).draw()}})}}function j(){var z={method:"market_history_api.get_ticker",params:{}};o.send(z,function(B,A){if(!B){A.latest=Asset.parse({amount:A.latest,nai:"cbd",exponent:6}).toPlainString();A.lowest_ask=Asset.parse({amount:A.lowest_ask,nai:"cbd",exponent:6}).toPlainString();A.highest_bid=Asset.parse({amount:A.highest_bid,nai:"cbd",exponent:6}).toPlainString();A.percent_change=parseFloat(A.percent_change).toFixed(3);A.penultimate=s.ticker.penultimate;if(s.ticker.latest!==A.latest){A.penultimate=s.ticker.latest}s.ticker=A;s.$forceUpdate()}else{console.error("Error getting ticker",B)}})}function u(){var z={method:"condenser_api.get_order_book",params:[100]};o.send(z,function(D,K){if(!catchError(D)){var F=[];var E=[];var G=mixToArray(l.rows().data());var H=mixToArray(c.rows().data());var J=function(L){return{price:L.order_price,crea:L.crea,cbd:L.cbd,total_cbd:L.total_cbd}};var C=0;var B=0;K.bids.forEach(function(M,L){M.order_price=Asset.parse({amount:M.real_price,nai:"cbd",exponent:6}).toPlainString();M.crea=Asset.parse({amount:M.crea,nai:"crea"}).toPlainString();M.cbd=Asset.parse({amount:M.cbd,nai:"cbd"}).toPlainString();C+=parseFloat(M.cbd);M.total_cbd=Asset.parse({amount:C,nai:"cbd"}).toPlainString();F.push(J(M))});F.sort(function(M,L){return L.price-M.price});if(!isEqual(G,F)){l.clear();i.clear();l.rows.add(F).draw();i.rows.add(F).draw()}K.asks.forEach(function(M,L){M.order_price=Asset.parse({amount:M.real_price,nai:"cbd",exponent:6}).toPlainString();M.crea=Asset.parse({amount:M.crea,nai:"crea"}).toPlainString();M.cbd=Asset.parse({amount:M.cbd,nai:"cbd"}).toPlainString();B+=parseFloat(M.cbd);M.total_cbd=Asset.parse({amount:B,nai:"cbd"}).toPlainString();E.push(J(M))});E.sort(function(M,L){return L.price-M.price});if(!isEqual(H,E)){c.clear();f.clear();c.rows.add(E).draw();f.rows.add(E).draw();var I=$(c.table().node()).parent();I.scrollTop(I.get(0).scrollHeight);var A=$(f.table().node()).parent();A.scrollTop(A.get(0).scrollHeight)}}})}function n(z,A){if(z){$("[buy-last-price]").html(z)}if(A){$("[sell-last-price]").html(A)}}function k(){var z={method:"market_history_api.get_recent_trades",params:{limit:100}};o.send(z,function(E,B){if(!E){var F=[];var C,A;B.trades.sort(function(H,G){return new Date(G.date).getTime()-new Date(H.date).getTime()});B.trades.forEach(function(H){H.date=moment(toLocaleDate(H.date)).fromNow();var I=Asset.parse(H.current_pays);var G=Asset.parse(H.open_pays);H.current_pays=I.toPlainString();H.open_pays=G.toPlainString();H.cbd=I.asset.symbol==="CBD"?H.current_pays:H.open_pays;H.crea=I.asset.symbol==="CBD"?H.open_pays:H.current_pays;H.type=I.asset.symbol==="CBD"?"buy":"sell";H.price=Asset.parse({amount:I.asset.symbol==="CBD"?(H.current_pays/H.open_pays):(H.open_pays/H.current_pays),nai:"cbd",exponent:6}).toPlainString();F.push(H);if(H.type==="sell"&&!C){C=H.price}if(H.type==="buy"&&!A){A=H.price}});var D=mixToArray(h.rows().data());if(!isEqual(D,F)){h.clear();h.rows.add(F).draw()}n(C,A)}else{console.error("Error getting recent trades",E)}})}function b(){var z={method:"market_history_api.get_market_history",params:{bucket_seconds:86400,end:moment().format("YYYY-MM-DD[T]H:mm:ss"),start:"2019-02-19T00:00:00"}};o.send(z,function(C,A){if(!C){var B=[];A.buckets.forEach(function(D){var E={date:moment(D.open).format("DD-MM-YYYY H:mm"),open:Asset.parse({amount:D.non_crea.open,nai:"cbd"}).toFloat(),high:Asset.parse({amount:D.non_crea.high,nai:"cbd"}).toFloat(),low:Asset.parse({amount:D.non_crea.low,nai:"cbd"}).toFloat(),close:Asset.parse({amount:D.non_crea.close,nai:"cbd"}).toFloat()};B.push(E)});if(!isEqual(q?q.data:[],B)){d(B)}}else{console.error("Fail getting chart data",C)}})}function e(A,z){var B=function(){j();w();u();k();b()};if(z||z===undefined){B()}if(A){setInterval(function(){B()},A)}}function d(C){if(!q){am4core.useTheme(am4themes_animated);q=am4core.create("market-chart",am4charts.XYChart);q.paddingRight=20;q.dateFormatter.inputDateFormat="dd-MM-yyyy HH:mm";var B=q.xAxes.push(new am4charts.DateAxis());B.renderer.grid.template.location=0;var E=q.yAxes.push(new am4charts.ValueAxis());E.tooltip.disabled=true;var A=q.series.push(new am4charts.CandlestickSeries());A.dataFields.dateX="date";A.dataFields.valueY="close";A.dataFields.openValueY="open";A.dataFields.lowValueY="low";A.dataFields.highValueY="high";A.simplifiedProcessing=true;A.tooltipText="Open: ${openValueY.value}\nLow: ${lowValueY.value}\nHigh: ${highValueY.value}\nClose: ${valueY.value}";A.riseFromOpenState.properties.fill=am4core.color("#25D77C");A.dropFromOpenState.properties.fill=am4core.color("#ff5766");A.riseFromOpenState.properties.stroke=am4core.color("#25D77C");A.dropFromOpenState.properties.stroke=am4core.color("#ff5766");q.cursor=new am4charts.XYCursor();var D=q.series.push(new am4charts.LineSeries());D.dataFields.dateX="date";D.dataFields.valueY="close";D.defaultState.properties.visible=false;D.hiddenInLegend=true;D.fillOpacity=0.5;D.strokeOpacity=0.5;var z=new am4charts.XYChartScrollbar();z.series.push(D);q.scrollbarX=z}q.data=C}function r(){if(!p){p=true;$.fn.dataTable.render.ellipsis=function(){return function(A,z,B){return z==="display"&&A.length>10?A.substr(0,10)+"…":A}};l=$("#buy-orders").DataTable({bFilter:false,bInfo:false,aoColumnDefs:[{orderable:false,aTargets:["_all"]}],order:[],scrollY:"250px",scrollCollapse:true,paging:false,columns:[{data:"price",className:"color-buy",render:$.fn.dataTable.render.ellipsis()},{data:"crea",render:$.fn.dataTable.render.ellipsis()},{data:"cbd",render:$.fn.dataTable.render.ellipsis()}],fnCreatedRow:function(B,A,z){$(B).click(function(){x(A,"sell")})}});i=$("#buy-orders-all").DataTable({bFilter:false,bInfo:false,lengthChange:false,aoColumnDefs:[{orderable:false,aTargets:["_all"]}],order:[],scrollY:"400px",scrollCollapse:true,paging:false,columns:[{data:"price",className:"color-buy",render:$.fn.dataTable.render.ellipsis()},{data:"crea",render:$.fn.dataTable.render.ellipsis()},{data:"cbd",render:$.fn.dataTable.render.ellipsis()}],fnCreatedRow:function(B,A,z){$(B).click(function(){x(A,"sell")})}});c=$("#sell-orders").DataTable({bFilter:false,bInfo:false,lengthChange:false,aoColumnDefs:[{orderable:false,aTargets:["_all"]}],order:[],scrollY:"250px",scrollCollapse:true,paging:false,columns:[{data:"price",className:"color-sell",render:$.fn.dataTable.render.ellipsis()},{data:"crea",render:$.fn.dataTable.render.ellipsis()},{data:"cbd",render:$.fn.dataTable.render.ellipsis()}],fnCreatedRow:function(B,A,z){$(B).click(function(){x(A,"buy")})}});f=$("#sell-all-orders").DataTable({bFilter:false,bInfo:false,lengthChange:false,aoColumnDefs:[{orderable:false,aTargets:["_all"]}],order:[],scrollY:"400px",scrollCollapse:true,paging:false,columns:[{data:"price",className:"color-sell",render:$.fn.dataTable.render.ellipsis()},{data:"crea",render:$.fn.dataTable.render.ellipsis()},{data:"cbd",render:$.fn.dataTable.render.ellipsis()}],fnCreatedRow:function(B,A,z){$(B).click(function(){x(A,"buy")})}});y=$("#user-orders").DataTable({bFilter:false,bInfo:false,lengthChange:false,aoColumnDefs:[{orderable:false,aTargets:["_all"]}],order:[],scrollY:"534px",scrollCollapse:true,paging:false,columns:[{data:"date"},{data:"expiration"},{data:"type",render:function(B,z,A,C){if(B.toLowerCase()==="buy"){return'<span class="color-buy">'+B.toUpperCase()+"</span>"}else{return'<span class="color-sell">'+B.toUpperCase()+"</span>"}}},{data:"price"},{data:"crea"},{data:"cbd"},{data:"action",render:function(B,z,A,C){return'<div id="'+A.orderid+'" class="btn btn--sm"><span class="btn__text text__dark font-weight-bold"> '+lang.BUTTON.CANCEL+"</span></a>"}}],fnCreatedRow:function(B,A,z){$("#"+A.orderid,B).click(function(){v(A.orderid)})}});h=$("#market-history").DataTable({bFilter:false,bInfo:false,lengthChange:false,aoColumnDefs:[{orderable:false,aTargets:["_all"]}],order:[],scrollY:"200px",scrollCollapse:true,paging:false,columns:[{data:"date",render:$.fn.dataTable.render.ellipsis()},{data:"price",render:function(B,z,A,C){if(A.type.toLowerCase()==="buy"){return'<span class="color-buy">'+B+"</span>"}else{return'<span class="color-sell">'+B+"</span>"}}},{data:"crea",render:$.fn.dataTable.render.ellipsis()},{data:"cbd",render:$.fn.dataTable.render.ellipsis()}]})}}function m(A,z){a=A;g=z;t()}creaEvents.on("crea.session.login",function(A,z){creaEvents.emit("crea.dom.ready");m(A,z);setTimeout(function(){console.log("session started");r();e(3000)},500)});creaEvents.on("crea.session.update",function(A,z){m(A,z)});$(window).on("beforeunload",function(){console.log("before unload event");o.close()})})();