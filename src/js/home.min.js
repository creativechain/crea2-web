"use strict";(function(){var g;var e;var f,d;function a(n,w,o){var F=o.content;var u=o.accounts;var K=Object.keys(F);var L=[];for(var v=0;v<K.length;v++){var G=K[v];if(!F[G].parent_author){F[G].metadata=jsonify(F[G].json_metadata);L.push(G)}}o.content=F;var C=Object.keys(u);C.forEach(function(x){u[x]=parseAccount(u[x])});o.accounts=u;if(w.startsWith("/")){w=w.substring(1)}var D=resolveFilter("/"+getPathPart()).replace("/","");var j=getPathPart(1)||"";if(isUserFeed(getPathPart())&&!o.discussion_idx[j]){K=L;K.sort(function(N,M){var x=toLocaleDate(F[N].created);var k=toLocaleDate(F[M].created);return k.getTime()-x.getTime()});o.discussion_idx[j]={};o.discussion_idx[j][D]=K;e=e?e:1}else{if(window.location.pathname==="/search"){e=getParameterByName("page")||1}else{var r=o.discussion_idx[j][D];e=o.content[r[r.length-1]]}}o.discussion_idx[j][D]=removeBlockedContents(o,d,o.discussion_idx[j][D]);if(!g){g=new Vue({el:"#home-posts",data:{session:f,account:d,filter:w,category:D,discuss:j,urlFilter:n,state:o,search:getParameterByName("query"),simpleView:false,lang:lang},updated:function J(){if(mr.masonry){mr.masonry.windowLoad();mr.masonry.updateLayout()}},methods:{isFeed:function(){return isUserFeed()},getDefaultAvatar:R.getAvatar,toggleSimpleView:function(){this.simpleView=!this.simpleView;console.log("SimpleView",this.simpleView)},onFollow:function s(x,k){updateUserSession()},openPost:showPost,parseAsset:function B(k){return Asset.parse(k).toFriendlyString()},getBuzzClass:function E(M){var x={};var k=M.buzz.level_name;x[k]=true;return x},getFeaturedImage:function t(x){var k=x.metadata.featuredImage;if(k&&k.hash){return{url:apiOptions.ipfs+k.hash}}else{if(k&&k.url){return k}}return{}},getTags:function m(x){var k=x.metadata.tags;var M=[];k=k.slice(0,7);k.forEach(function(N){M.push('<a href="/search?page=1&query='+encodeURIComponent(N)+'">'+N+"</a>")});return M.join(", ")},getFutureDate:function l(k){return moment(toLocaleDate(k)).fromNow()},hasPaid:function I(M){var x=new Date();var k=toLocaleDate(M.cashout_time);return x.getTime()>k.getTime()},getPayoutPostDate:function H(x){var k=toLocaleDate(x.cashout_time);if(this.hasPaid(x)){k=toLocaleDate(x.last_payout)}return moment(k).fromNow()},hasPromotion:function z(x){var k=Asset.parseString(x.promoted);return k.amount>0},getPromotion:function y(x){var k=Asset.parseString(x.promoted);return"$ "+k.toPlainString()},getPayout:function q(x){var k=Asset.parseString(x.pending_payout_value);if(this.hasPaid(x)){k=Asset.parseString(x.total_payout_value);k=k.add(Asset.parseString(x.curator_payout_value))}return"$ "+k.toPlainString()},getPendingPayouts:function p(T,x){x=x?x.toLowerCase():"";var V=Asset.parse({amount:Asset.parseString(this.state.feed_price.base).toFloat()/Asset.parseString(this.state.feed_price.quote).toFloat(),nai:"cbd"});var O=this.state.props.cbd_print_rate;var M=10000;var Q=Asset.parse(T.pending_payout_value);var P=Q;var W=T.percent_crea_dollars/20000;var N=Asset.parse({amount:P.toFloat()*W,nai:"cbd"});var S=Asset.parse({amount:NaNOr(((P.toFloat()-N.toFloat())/V.toFloat()),0),nai:"cgy"});var U=Asset.parse({amount:NaNOr((N.toFloat()*(O/M)),0),nai:"cbd"});var k=Asset.parse({amount:NaNOr(((N.toFloat()-U.toFloat())/V.toFloat()),0),nai:"crea"});switch(x){case"cgy":return S.toFriendlyString(null,false);case"cbd":return U.toFriendlyString(null,false);case"crea":return k.toFriendlyString(null,false);default:return"("+U.toFriendlyString(null,false)+", "+k.toFriendlyString(null,false)+", "+S.toFriendlyString(null,false)+")"}},parseJSON:function i(k){if(k&&k.length>0){try{return JSON.parse(k)}catch(x){catchError(x)}}return{}},onVote:function h(N,k,x){catchError(N);var M=this;getDiscussion(x.author,x.permlink,function(Q,O){if(!Q){var P=parsePost(O,x.reblogged_by);M.state.content[P.link]=P;M.$forceUpdate()}})},getLicense:function A(k){if(k){return License.fromFlag(k)}return new License(LICENSE.FREE_CONTENT)}}})}else{g.session=f;g.account=d;g.filter=w;g.category=D;g.discuss=j;g.state=o;g.urlFilter=n;g.search=getParameterByName("query")}g.$forceUpdate();creaEvents.emit("crea.dom.ready")}creaEvents.on("crea.posts",function(s,j,i){var p=[];for(var m in i.content){var l=i.content[m].author;if(!p.includes(l)){p.push(l)}i.content[m]=parsePost(i.content[m])}if(isUserFeed(getPathPart())){getAccounts(p,function(y,u){if(!catchError(y)){var x={};u.forEach(function(z){x[z.name]=z});if(g){for(var v in x){g.state.accounts[v]=x[v]}for(var w in i.content){g.state.content[w]=parsePost(i.content[w])}i=g.state}else{i.accounts=x}a(s,j,i)}})}else{if(g&&g.urlFilter===s&&s==="/search"){var n=getParameterByName("query");if(n===g.search&&n!==null){for(var r in i.accounts){g.state.accounts[r]=parseAccount(i.accounts[r])}for(var h in i.content){g.state.content[h]=parsePost(i.content[h])}var k=i.discussion_idx[""].search;for(var q=0;q<k.length;q++){if(!g.state.discussion_idx[""].search.includes(k[q])){g.state.discussion_idx[""].search.push(k[q])}}g.state.discussion_idx[""].search=removeBlockedContents(g.state,d,g.state.discussion_idx[""].search)}else{a(s,j,i)}}else{if(g&&g.urlFilter===s){for(var o in i.accounts){g.state.accounts[o]=parseAccount(i.accounts[o])}for(var t in i.content){g.state.content[t]=parsePost(i.content[t])}i=g.state}a(s,j,i)}}});function c(k){var j=window.location.pathname;if(j==="/"){if(f){k=k?k:"/@"+f.account.username+"/feed";creaEvents.emit("crea.content.filter",k)}else{creaEvents.emit("crea.content.filter","/popular")}}else{if(isUserFeed(getPathPart())){if(f){if(getPathPart()!==("@"+f.account.username)){showProfile(getPathPart())}else{creaEvents.emit("crea.content.filter",j)}}else{showProfile(getPathPart())}}else{if(j.startsWith("/search")){var h=getParameterByName("query");var i=getParameterByName("page")||1;performSearch(h,i,true)}else{creaEvents.emit("crea.content.filter",j)}}}}creaEvents.on("crea.session.update",function(i,h){g.session=f=i;g.account=d=h;c(g.urlFilter)});creaEvents.on("crea.session.login",function(i,h){f=i;d=h;c()});var b;creaEvents.on("crea.scroll.bottom",function(){if(!b){b=true;if(isUserFeed()){var h=new HttpClient(apiOptions.apiUrl+"/creary/feed");h.when("done",function(n){var r=jsonify(n).data;if(r.length){var q=r.length;var p=[];var o=[];var s=function s(){q--;if(q<=0){getAccounts(o,function(u,w){if(!catchError(u)){w.forEach(function(x){g.state.accounts[x.name]=parseAccount(x)});p.sort(function(A,z){var y=toLocaleDate(A.created);var x=toLocaleDate(z.created);return x.getTime()-y.getTime()});var v=g.discuss;var t=g.category;p.forEach(function(y){var x=y.author+"/"+y.permlink;g.state.content[x]=y;g.state.discussion_idx[v][t].push(x)});g.state.discussion_idx[v][t]=removeBlockedContents(g.state,d,g.state.discussion_idx[v][t]);g.$forceUpdate()}b=false})}else{b=false}};r.forEach(function(u){var t=u.author+"/"+u.permlink;if(!g.state.content[t]){crea.api.getContent(u.author,u.permlink,function(w,v){if(w){console.error("Error getting",t,w)}else{var x=parsePost(v);x.reblogged_by=u.reblogged_by;p.push(x);if(!g.state.accounts[u.author]&&!o.includes(u.author)){o.push(u.author)}}s()})}else{g.state.content[t].reblogged_by=u.reblogged_by}})}else{b=false;--e}});h.when("fail",function(n,p,o){b=false;catchError(p)});var m=getPathPart().replace("/","").replace("@","");crea.api.getFollowing(m,"","blog",1000,function(p,n){if(!catchError(p)){var o=[];n.following.forEach(function(q){o.push(q.following)});if(o.length){o=o.join(",");refreshAccessToken(function(q){h.headers={Authorization:"Bearer "+q};e++;h.post({following:o,page:e,reblogs:true})})}}})}else{if(window.location.pathname==="/search"){var l=getParameterByName("query");var j=Object.keys(g.state.content).length;if(j>0&&j%20===0){globalLoading.show=true;performSearch(l,++e,true,function(){b=false;globalLoading.show=false})}}else{var i;var k=g.category;switch(k){case"now":i=crea.api.getDiscussionsByNow;break;case"skyrockets":i=crea.api.getDiscussionsBySkyrockets;break;case"promoted":i=crea.api.getDiscussionsByPromoted;break;case"popular":i=crea.api.getDiscussionsByPopular;break;default:i=crea.api["getDiscussionsBy"+k.capitalize()];break}if(i){i(e.author,e.permlink,21,function(r,o){if(r){console.error(r)}else{var q=o.discussions;q.shift();var p=[];for(var n=0;n<q.length;n++){var s=q[n];q[n]=parsePost(s);if(!g.state.accounts[s.author]&&!p.includes(s.author)){p.push(s.author)}}getAccounts(p,function(t,v){if(!catchError(t)){v.forEach(function(w){g.state.accounts[w.name]=w});var u=g.discuss;q.forEach(function(x){var w=x.author+"/"+x.permlink;g.state.content[w]=x;g.state.discussion_idx[u][k].push(w)});g.state.discussion_idx[u][k]=removeBlockedContents(g.state,d,g.state.discussion_idx[u][k]);e=q[q.length-1];g.$forceUpdate()}b=false})}})}}}}});creaEvents.on("crea.search.content",function(l){var k={content:{},accounts:{},discussion:[]};var i=0;var j=function j(n){i++;if(i>=l.length){console.log(n);n.content=k.content;n.accounts=k.accounts;k.discussion.sort(function(p,o){return n.content[o].active_votes.length-n.content[p].active_votes.length});n.discussion_idx[""]={};n.discussion_idx[""].search=k.discussion;creaEvents.emit("crea.posts","/search","search",n)}};var m=function m(n){var o=function o(q){var s=q.author+"/"+q.permlink;var p="/"+q.tags[0]+"/@"+s;crea.api.getState(p,function(t,r){if(t){console.error(t);o(q)}else{k.discussion.push(s);k.accounts[q.author]=r.accounts[q.author];k.content[s]=r.content[s];j(r)}})};o(l[n])};for(var h=0;h<l.length;h++){m(h)}if(l.length===0){crea.api.getState("/no_results",function(o,n){if(!catchError(o)){j(n)}})}});creaEvents.on("crea.dom.ready",function(){$("#view-changer").click(function(){g.toggleSimpleView()})})})();