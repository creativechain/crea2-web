"use strict";var homePosts;(function(){var e;var f,d;function a(m,v,n){var E=n.content;var t=n.accounts;var J=Object.keys(E);var K=[];for(var u=0;u<J.length;u++){var F=J[u];if(!E[F].parent_author){E[F].metadata=jsonify(E[F].json_metadata);K.push(F)}}n.content=E;var B=Object.keys(t);B.forEach(function(x){t[x]=parseAccount(t[x])});n.accounts=t;if(v.startsWith("/")){v=v.substring(1)}var C=resolveFilter("/"+getPathPart()).replace("/","");var i=getPathPart(1)||"";if(isUserFeed(getPathPart())&&!n.discussion_idx[i]){J=K;J.sort(function(M,L){var x=toLocaleDate(E[M].created);var k=toLocaleDate(E[L].created);return k.getTime()-x.getTime()});n.discussion_idx[i]={};n.discussion_idx[i][C]=J;e=e?e:1}else{if(window.location.pathname==="/search"){e=getParameterByName("page")||1}else{var q=n.discussion_idx[i][C];e=n.content[q[q.length-1]]}}n.discussion_idx[i][C]=removeBlockedContents(n,d,n.discussion_idx[i][C]);if(!homePosts){homePosts=new Vue({el:"#home-posts",data:{session:f,account:d,filter:v,category:C,discuss:i,urlFilter:m,state:n,search:getParameterByName("query"),simpleView:false,lang:lang},updated:function I(){if(mr.masonry){mr.masonry.windowLoad();mr.masonry.updateLayout()}},methods:{isFeed:function(){return isUserFeed()},getDefaultAvatar:R.getAvatar,toggleSimpleView:function(){this.simpleView=!this.simpleView;console.log("SimpleView",this.simpleView)},onFollow:function r(x,k){updateUserSession()},openPost:showPost,parseAsset:function A(k){return Asset.parse(k).toFriendlyString()},getBuzzClass:function D(L){var x={};var k=L.buzz.level_name;x[k]=true;return x},getFeaturedImage:function s(x){var k=x.metadata.featuredImage;if(k&&k.hash){return{url:apiOptions.ipfs+k.hash}}else{if(k&&k.url){return k}}return{}},getTags:function l(x){var k=x.metadata.tags;var L=[];k=k.slice(0,7);k.forEach(function(M){L.push('<a href="/search?page=1&query='+encodeURIComponent(M)+'">'+M+"</a>")});return L.join(", ")},getFutureDate:function j(k){return moment(toLocaleDate(k)).fromNow()},hasPaid:function H(L){var x=new Date();var k=toLocaleDate(L.cashout_time);return x.getTime()>k.getTime()},getPayoutPostDate:function G(x){var k=toLocaleDate(x.cashout_time);if(this.hasPaid(x)){k=toLocaleDate(x.last_payout)}return moment(k).fromNow()},hasPromotion:function y(x){var k=Asset.parseString(x.promoted);return k.amount>0},getPromotion:function w(x){var k=Asset.parseString(x.promoted);return"$ "+k.toPlainString()},getPayout:function p(x){var k=Asset.parseString(x.pending_payout_value);if(this.hasPaid(x)){k=Asset.parseString(x.total_payout_value);k=k.add(Asset.parseString(x.curator_payout_value))}return"$ "+k.toPlainString()},getPendingPayouts:function o(S,x){x=x?x.toLowerCase():"";var U=Asset.parse({amount:Asset.parseString(this.state.feed_price.base).toFloat()/Asset.parseString(this.state.feed_price.quote).toFloat(),nai:"cbd"});var N=this.state.props.cbd_print_rate;var L=10000;var P=Asset.parse(S.pending_payout_value);var O=P;var V=S.percent_crea_dollars/20000;var M=Asset.parse({amount:O.toFloat()*V,nai:"cbd"});var Q=Asset.parse({amount:NaNOr(((O.toFloat()-M.toFloat())/U.toFloat()),0),nai:"cgy"});var T=Asset.parse({amount:NaNOr((M.toFloat()*(N/L)),0),nai:"cbd"});var k=Asset.parse({amount:NaNOr(((M.toFloat()-T.toFloat())/U.toFloat()),0),nai:"crea"});switch(x){case"cgy":return Q.toFriendlyString(null,false);case"cbd":return T.toFriendlyString(null,false);case"crea":return k.toFriendlyString(null,false);default:return"("+T.toFriendlyString(null,false)+", "+k.toFriendlyString(null,false)+", "+Q.toFriendlyString(null,false)+")"}},parseJSON:function h(k){if(k&&k.length>0){try{return JSON.parse(k)}catch(x){catchError(x)}}return{}},onVote:function g(M,k,x){catchError(M);var L=this;getDiscussion(x.author,x.permlink,function(P,N){if(!P){var O=parsePost(N);L.state.content[O.link]=O;L.$forceUpdate()}})},getLicense:function z(k){if(k){return License.fromFlag(k)}return new License(LICENSE.FREE_CONTENT)}}})}else{homePosts.session=f;homePosts.account=d;homePosts.filter=v;homePosts.category=C;homePosts.discuss=i;homePosts.state=n;homePosts.urlFilter=m;homePosts.search=getParameterByName("query")}homePosts.$forceUpdate();creaEvents.emit("crea.dom.ready")}creaEvents.on("crea.posts",function(r,i,h){var o=[];for(var l in h.content){var k=h.content[l].author;if(!o.includes(k)){o.push(k)}h.content[l]=parsePost(h.content[l])}if(isUserFeed(getPathPart())){getAccounts(o,function(x,t){if(!catchError(x)){var w={};t.forEach(function(y){w[y.name]=y});if(homePosts){for(var u in w){homePosts.state.accounts[u]=w[u]}for(var v in h.content){homePosts.state.content[v]=parsePost(h.content[v])}h=homePosts.state}else{h.accounts=w}a(r,i,h)}})}else{if(homePosts&&homePosts.urlFilter===r&&r==="/search"){var m=getParameterByName("query");if(m===homePosts.search&&m!==null){for(var q in h.accounts){homePosts.state.accounts[q]=parseAccount(h.accounts[q])}for(var g in h.content){homePosts.state.content[g]=parsePost(h.content[g])}var j=h.discussion_idx[""].search;for(var p=0;p<j.length;p++){if(!homePosts.state.discussion_idx[""].search.includes(j[p])){homePosts.state.discussion_idx[""].search.push(j[p])}}homePosts.state.discussion_idx[""].search=removeBlockedContents(homePosts.state,d,homePosts.state.discussion_idx[""].search)}else{a(r,i,h)}}else{if(homePosts&&homePosts.urlFilter===r){for(var n in h.accounts){homePosts.state.accounts[n]=parseAccount(h.accounts[n])}for(var s in h.content){homePosts.state.content[s]=parsePost(h.content[s])}h=homePosts.state}a(r,i,h)}}});function c(j){var i=window.location.pathname;if(i==="/"){if(f){j=j?j:"/@"+f.account.username+"/feed";creaEvents.emit("crea.content.filter",j)}else{creaEvents.emit("crea.content.filter","/popular")}}else{if(isUserFeed(getPathPart())){if(f){if(getPathPart()!==("@"+f.account.username)){showProfile(getPathPart())}else{creaEvents.emit("crea.content.filter",i)}}else{showProfile(getPathPart())}}else{if(i.startsWith("/search")){var g=getParameterByName("query");var h=getParameterByName("page")||1;performSearch(g,h,true)}else{creaEvents.emit("crea.content.filter",i)}}}}creaEvents.on("crea.session.update",function(h,g){homePosts.session=f=h;homePosts.account=d=g;c(homePosts.urlFilter)});creaEvents.on("crea.session.login",function(h,g){f=h;d=g;c()});var b;creaEvents.on("crea.scroll.bottom",function(){if(!b){b=true;if(isUserFeed()){var g=new HttpClient(apiOptions.apiUrl+"/creary/feed");g.when("done",function(m){var q=jsonify(m).data;if(q.length){var p=q.length;var o=[];var n=[];var r=function r(){p--;if(p<=0){getAccounts(n,function(t,v){if(!catchError(t)){v.forEach(function(w){homePosts.state.accounts[w.name]=parseAccount(w)});o.sort(function(z,y){var x=toLocaleDate(z.created);var w=toLocaleDate(y.created);return w.getTime()-x.getTime()});var u=homePosts.discuss;var s=homePosts.category;o.forEach(function(x){var w=x.author+"/"+x.permlink;homePosts.state.content[w]=x;homePosts.state.discussion_idx[u][s].push(w)});homePosts.state.discussion_idx[u][s]=removeBlockedContents(homePosts.state,d,homePosts.state.discussion_idx[u][s]);homePosts.$forceUpdate()}b=false})}else{b=false}};q.forEach(function(t){var s=t.author+"/"+t.permlink;if(!homePosts.state.content[s]){crea.api.getContent(t.author,t.permlink,function(v,u){if(v){console.error("Error getting",s,v)}else{var w=parsePost(u);w.reblogged_by=t.reblogged_by;o.push(w);if(!homePosts.state.accounts[t.author]&&!n.includes(t.author)){n.push(t.author)}}r()})}else{homePosts.state.content[s].reblogged_by=t.reblogged_by}})}else{b=false;--e}});g.when("fail",function(m,o,n){b=false;catchError(o)});var l=getPathPart().replace("/","").replace("@","");crea.api.getFollowing(l,"","blog",1000,function(o,m){if(!catchError(o)){var n=[];m.following.forEach(function(p){n.push(p.following)});if(n.length){n=n.join(",");refreshAccessToken(function(p){g.headers={Authorization:"Bearer "+p};e++;g.post({following:n,page:e})})}}})}else{if(window.location.pathname==="/search"){var k=getParameterByName("query");var i=Object.keys(homePosts.state.content).length;if(i>0&&i%20===0){globalLoading.show=true;performSearch(k,++e,true,function(){b=false;globalLoading.show=false})}}else{var h;var j=homePosts.category;switch(j){case"now":h=crea.api.getDiscussionsByNow;break;case"skyrockets":h=crea.api.getDiscussionsBySkyrockets;break;case"promoted":h=crea.api.getDiscussionsByPromoted;break;case"popular":h=crea.api.getDiscussionsByPopular;break;default:h=crea.api["getDiscussionsBy"+j.capitalize()];break}if(h){h(e.author,e.permlink,21,function(q,n){if(q){console.error(q)}else{var p=n.discussions;p.shift();var o=[];for(var m=0;m<p.length;m++){var r=p[m];p[m]=parsePost(r);if(!homePosts.state.accounts[r.author]&&!o.includes(r.author)){o.push(r.author)}}getAccounts(o,function(s,u){if(!catchError(s)){u.forEach(function(v){homePosts.state.accounts[v.name]=v});var t=homePosts.discuss;p.forEach(function(w){var v=w.author+"/"+w.permlink;homePosts.state.content[v]=w;homePosts.state.discussion_idx[t][j].push(v)});homePosts.state.discussion_idx[t][j]=removeBlockedContents(homePosts.state,d,homePosts.state.discussion_idx[t][j]);e=p[p.length-1];homePosts.$forceUpdate()}b=false})}})}}}}});creaEvents.on("crea.search.content",function(k){var j={content:{},accounts:{},discussion:[]};var h=0;var i=function i(m){h++;if(h>=k.length){console.log(m);m.content=j.content;m.accounts=j.accounts;j.discussion.sort(function(o,n){return m.content[n].active_votes.length-m.content[o].active_votes.length});m.discussion_idx[""]={};m.discussion_idx[""].search=j.discussion;creaEvents.emit("crea.posts","/search","search",m)}};var l=function l(m){var n=function n(p){var q=p.author+"/"+p.permlink;var o="/"+p.tags[0]+"/@"+q;crea.api.getState(o,function(s,r){if(s){console.error(s);n(p)}else{j.discussion.push(q);j.accounts[p.author]=r.accounts[p.author];j.content[q]=r.content[q];i(r)}})};n(k[m])};for(var g=0;g<k.length;g++){l(g)}if(k.length===0){crea.api.getState("/no_results",function(n,m){if(!catchError(n)){i(m)}})}});creaEvents.on("crea.dom.ready",function(){$("#view-changer").click(function(){homePosts.toggleSimpleView()})})})();