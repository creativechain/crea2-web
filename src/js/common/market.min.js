(function(){function z(){d?(d.session=g,d.account=t,d.$forceUpdate()):d=new Vue({el:"#market-container",data:{lang:lang,session:g,account:t,recentTrades:[],ticker:{penultimate:null,latest:"0.000000",lowest_ask:"0.000000",highest_bid:"0.000000",percent_change:"0.000000",crea_volume:"0.000 CREA",cbd_volume:"0.000 CREA"},buyForm:{price:"0.000",amount:"0.000",total:"0.000"},sellForm:{price:"0.000",amount:"0.000",total:"0.000"}},methods:{parseAsset:Asset.parse,dateFromNow:function(b){return toLocaleDate(b).fromNow()},
priceFor:function(b,a){b=Asset.parse(b);a=Asset.parse(a);b=a.toFloat()/b.toFloat();return Asset.parse({amount:b,nai:a.asset.symbol})},clearOrderForm:function(b){b=b.toLowerCase();"buy"===b?(this.buyForm.price="0.000",this.buyForm.amount="0.000",this.buyForm.total="0.000"):(this.sellForm.price="0.000",this.sellForm.amount="0.000",this.sellForm.total="0.000")},onParseBuyForm:function(){this.buyForm.price=Asset.parse({amount:this.buyForm.price?parseFloat(this.buyForm.price)+1E-4:"0.000",nai:"cbd"}).toPlainString();
this.buyForm.amount=Asset.parse({amount:this.buyForm.amount?parseFloat(this.buyForm.amount)+1E-4:"0.000",nai:"cbd"}).toPlainString();isNaN(this.buyForm.price)||isNaN(this.buyForm.amount)?this.buyForm.total=Asset.parse({amount:parseFloat(this.buyForm.total)+1E-4,nai:"cbd"}).toPlainString():this.buyForm.total=Asset.parse({amount:parseFloat(this.buyForm.price*this.buyForm.amount)+1E-4,nai:"cbd"}).toPlainString()},inputBuy:function(b,a){a=a.toLowerCase();var c=b.which?b.which:b.keyCode;if(31<c&&(48>c||
57<c)&&46!==c)return cancelEventPropagation(b),!1;c=b.target.value;b=Asset.parse({amount:c,nai:"crea",exponent:3}).toPlainString();if(!isNaN(c)||!isNaN(b))switch(c=this.buyForm.amount,a){case "price":c&&(this.buyForm.total=Asset.parse({amount:(c*b).toString(),nai:"cbd",exponent:3}).toPlainString());break;case "amount":if(a=this.buyForm.price)this.buyForm.total=Asset.parse({amount:(b*a).toString(),nai:"cbd",exponent:3}).toPlainString();break;default:c&&(this.buyForm.price=Asset.parse({amount:(b/c).toString(),
nai:"cbd",exponent:3}).toPlainString())}return!0},onParseSellForm:function(){this.sellForm.price=Asset.parse({amount:this.sellForm.price?parseFloat(this.sellForm.price)+1E-4:"0.000",nai:"cbd"}).toPlainString();this.sellForm.amount=Asset.parse({amount:this.sellForm.amount?parseFloat(this.sellForm.amount)+1E-4:"0.000",nai:"cbd"}).toPlainString();isNaN(this.sellForm.price)||isNaN(this.sellForm.amount)?this.sellForm.total=Asset.parse({amount:parseFloat(this.sellForm.total)+1E-4,nai:"cbd"}).toPlainString():
this.sellForm.total=Asset.parse({amount:parseFloat(this.sellForm.price*this.sellForm.amount)+1E-4,nai:"cbd"}).toPlainString()},inputSell:function(b,a){a=a.toLowerCase();var c=b.which?b.which:b.keyCode;if(31<c&&(48>c||57<c)&&46!==c)return cancelEventPropagation(b),!1;b=b.target.value;c=Asset.parse({amount:b,nai:"crea",exponent:3}).toPlainString();if(!isNaN(b)||!isNaN(c))switch(c=this.sellForm.amount,a){case "price":c&&(this.sellForm.total=Asset.parse({amount:(c*b).toString(),nai:"cbd",exponent:3}).toPlainString());
break;case "amount":if(a=this.sellForm.price)this.sellForm.total=Asset.parse({amount:(b*a).toString(),nai:"cbd",exponent:3}).toPlainString();break;default:c&&(this.sellForm.price=Asset.parse({amount:(b/c).toString(),nai:"cbd",exponent:3}).toPlainString())}return!0},makeOrder:function(b){b=b.toLowerCase();var a=this;requireRoleKey(g?g.account.username:null,"active",function(c,e){var A=moment().add(28,"days").toDate();var k=randomNumber(0,4294967295);if("buy"===b){var l=a.buyForm.total+" CBD";var d=
a.buyForm.amount+" CREA"}else"sell"===b&&(l=a.sellForm.amount+" CREA",d=a.sellForm.total+" CBD");crea.broadcast.limitOrderCreate(c,e,k,l,d,!1,A,function(c,k){catchError(c)||(a.clearOrderForm(b),u(),updateUserSession())})})}}})}function n(b,a){a=a.toLowerCase();"buy"===a?(d.buyForm.price=b.price,d.buyForm.amount=b.crea,d.onParseBuyForm()):(d.sellForm.price=b.price,d.sellForm.amount=b.crea,d.onParseSellForm())}function B(b){requireRoleKey(g.account.username,"active",function(a){crea.broadcast.limitOrderCancel(a,
g.account.username,b,function(a,b){catchError(a)||(u(),updateUserSession())})})}function u(){g&&h.send({method:"condenser_api.get_open_orders",params:[g.account.username]},function(b,a){if(!catchError(b)){var c=function(a){var b=Asset.parse(a.sell_price.base),c=Asset.parse(a.sell_price.quote),e="CREA"===b.asset.symbol?"Sell":"Buy";return{date:toLocaleDate(a.created).format("MMM DD, YYYY H:mm:ss"),expiration:toLocaleDate(a.expiration).format("MMM DD, YYYY H:mm:ss"),type:e,price:"$"+Asset.parse({amount:("Buy"===
e?b.toFloat()/c.toFloat():c.toFloat()/b.toFloat())+1E-4,nai:"cbd"}).toPlainString(),crea:"Buy"===e?c.toFriendlyString():Asset.parse({amount:a.for_sale,nai:"crea"}).toFriendlyString(),cbd:"Buy"===e?Asset.parse({amount:a.for_sale,nai:"cbd"}).toFriendlyString():c.toFriendlyString(),action:"button",orderid:a.orderid}},e=[];a.forEach(function(a){e.push(c(a))});e.sort(function(a,b){return(new Date(b.date)).getTime()-(new Date(a.date)).getTime()});v.clear();v.rows.add(e).draw()}})}function C(){h.send({method:"market_history_api.get_ticker",
params:{}},function(b,a){b?console.error("Error getting ticker",b):(a.latest=Asset.parse({amount:a.latest,nai:"cbd",exponent:6}).toPlainString(),a.lowest_ask=Asset.parse({amount:a.lowest_ask,nai:"cbd",exponent:6}).toPlainString(),a.highest_bid=Asset.parse({amount:a.highest_bid,nai:"cbd",exponent:6}).toPlainString(),a.percent_change=parseFloat(a.percent_change).toFixed(3),a.penultimate=d.ticker.penultimate,d.ticker.latest!==a.latest&&(a.penultimate=d.ticker.latest),d.ticker=a,d.$forceUpdate())})}function D(){h.send({method:"condenser_api.get_order_book",
params:[100]},function(b,a){if(!catchError(b)){var c=[],e=[];b=mixToArray(p.rows().data());var d=mixToArray(m.rows().data()),k=function(a){return{price:a.order_price,crea:a.crea,cbd:a.cbd,total_cbd:a.total_cbd}},l=0,f=0;a.bids.forEach(function(a,b){a.order_price=Asset.parse({amount:a.real_price,nai:"cbd",exponent:6}).toPlainString();a.crea=Asset.parse({amount:a.crea,nai:"crea"}).toPlainString();a.cbd=Asset.parse({amount:a.cbd,nai:"cbd"}).toPlainString();l+=parseFloat(a.cbd);a.total_cbd=Asset.parse({amount:l,
nai:"cbd"}).toPlainString();c.push(k(a))});c.sort(function(a,b){return b.price-a.price});isEqual(b,c)||(p.clear(),w.clear(),p.rows.add(c).draw(),w.rows.add(c).draw());a.asks.forEach(function(a,b){a.order_price=Asset.parse({amount:a.real_price,nai:"cbd",exponent:6}).toPlainString();a.crea=Asset.parse({amount:a.crea,nai:"crea"}).toPlainString();a.cbd=Asset.parse({amount:a.cbd,nai:"cbd"}).toPlainString();f+=parseFloat(a.cbd);a.total_cbd=Asset.parse({amount:f,nai:"cbd"}).toPlainString();e.push(k(a))});
e.sort(function(a,b){return b.price-a.price});isEqual(d,e)||(m.clear(),q.clear(),m.rows.add(e).draw(),q.rows.add(e).draw(),a=$(m.table().node()).parent(),a.scrollTop(a.get(0).scrollHeight),a=$(q.table().node()).parent(),a.scrollTop(a.get(0).scrollHeight))}})}function E(b,a){b&&$("[buy-last-price]").html(b);a&&$("[sell-last-price]").html(a)}function F(){h.send({method:"market_history_api.get_recent_trades",params:{limit:100}},function(b,a){if(b)console.error("Error getting recent trades",b);else{var c=
[],e,d;a.trades.sort(function(a,b){return(new Date(b.date)).getTime()-(new Date(a.date)).getTime()});a.trades.forEach(function(a){a.date=toLocaleDate(a.date).fromNow();var b=Asset.parse(a.current_pays),f=Asset.parse(a.open_pays);a.current_pays=b.toPlainString();a.open_pays=f.toPlainString();a.cbd="CBD"===b.asset.symbol?a.current_pays:a.open_pays;a.crea="CBD"===b.asset.symbol?a.open_pays:a.current_pays;a.type="CBD"===b.asset.symbol?"buy":"sell";a.price=Asset.parse({amount:"CBD"===b.asset.symbol?a.current_pays/
a.open_pays:a.open_pays/a.current_pays,nai:"cbd",exponent:6}).toPlainString();c.push(a);"sell"!==a.type||e||(e=a.price);"buy"!==a.type||d||(d=a.price)});b=mixToArray(r.rows().data());isEqual(b,c)||(r.clear(),r.rows.add(c).draw());E(e,d)}})}function G(){var b=moment();b={method:"market_history_api.get_market_history",params:{bucket_seconds:86400,end:b.format("YYYY-MM-DD[T]H:mm:ss"),start:b.subtract(1,"months").format("YYYY-MM-DD[T]H:mm:ss")}};h.send(b,function(a,b){if(a)console.error("Fail getting chart data",
a);else{var c=[];b.buckets.forEach(function(a){var b=Asset.parse({amount:a.non_crea.high,nai:"cbd"}).toFloat(),d=Asset.parse({amount:a.non_crea.low,nai:"cbd"}).toFloat();a={date:toLocaleDate(a.open).format("DD-MM-YYYY H:mm"),open:Asset.parse({amount:a.non_crea.open,nai:"cbd"}).toFloat(),high:b>d?b:d,low:d>b?b:d,close:Asset.parse({amount:a.non_crea.close,nai:"cbd"}).toFloat()};c.push(a)});isEqual(f?f.data:[],c)||H(c)}})}function I(b,a){var c=function(){C();u();D();F();G()};(a||void 0===a)&&c();b&&
setInterval(function(){c()},b)}function H(b){if(!f){am4core.useTheme(am4themes_animated);f=am4core.create("market-chart",am4charts.XYChart);f.paddingRight=20;f.dateFormatter.inputDateFormat="dd-MM-yyyy HH:mm";f.xAxes.push(new am4charts.DateAxis).renderer.grid.template.location=0;f.yAxes.push(new am4charts.ValueAxis).tooltip.disabled=!0;var a=f.series.push(new am4charts.CandlestickSeries);a.dataFields.dateX="date";a.dataFields.valueY="close";a.dataFields.openValueY="open";a.dataFields.lowValueY="low";
a.dataFields.highValueY="high";a.simplifiedProcessing=!0;a.tooltipText="Open: ${openValueY.value}\nLow: ${lowValueY.value}\nHigh: ${highValueY.value}\nClose: ${valueY.value}";a.riseFromOpenState.properties.fill=am4core.color("#25D77C");a.dropFromOpenState.properties.fill=am4core.color("#ff5766");a.riseFromOpenState.properties.stroke=am4core.color("#25D77C");a.dropFromOpenState.properties.stroke=am4core.color("#ff5766");f.cursor=new am4charts.XYCursor;a=f.series.push(new am4charts.LineSeries);a.dataFields.dateX=
"date";a.dataFields.valueY="close";a.defaultState.properties.visible=!1;a.hiddenInLegend=!0;a.fillOpacity=.5;a.strokeOpacity=.5;var c=new am4charts.XYChartScrollbar;c.series.push(a);f.scrollbarX=c}f.data=b}function J(){x||(x=!0,$.fn.dataTable.render.ellipsis=function(){return function(b,a,c){return"display"===a&&10<b.length?b.substr(0,10)+"\u2026":b}},p=$("#buy-orders").DataTable({bFilter:!1,bInfo:!1,aoColumnDefs:[{orderable:!1,aTargets:["_all"]}],order:[],scrollY:"250px",scrollCollapse:!0,paging:!1,
columns:[{data:"price",className:"color-buy",render:$.fn.dataTable.render.ellipsis()},{data:"crea",render:$.fn.dataTable.render.ellipsis()},{data:"cbd",render:$.fn.dataTable.render.ellipsis()}],fnCreatedRow:function(b,a,c){$(b).click(function(){n(a,"sell")})}}),w=$("#buy-orders-all").DataTable({bFilter:!1,bInfo:!1,lengthChange:!1,aoColumnDefs:[{orderable:!1,aTargets:["_all"]}],order:[],scrollY:"400px",scrollCollapse:!0,paging:!1,columns:[{data:"price",className:"color-buy",render:$.fn.dataTable.render.ellipsis()},
{data:"crea",render:$.fn.dataTable.render.ellipsis()},{data:"cbd",render:$.fn.dataTable.render.ellipsis()}],fnCreatedRow:function(b,a,c){$(b).click(function(){n(a,"sell")})}}),m=$("#sell-orders").DataTable({bFilter:!1,bInfo:!1,lengthChange:!1,aoColumnDefs:[{orderable:!1,aTargets:["_all"]}],order:[],scrollY:"250px",scrollCollapse:!0,paging:!1,columns:[{data:"price",className:"color-sell",render:$.fn.dataTable.render.ellipsis()},{data:"crea",render:$.fn.dataTable.render.ellipsis()},{data:"cbd",render:$.fn.dataTable.render.ellipsis()}],
fnCreatedRow:function(b,a,c){$(b).click(function(){n(a,"buy")})}}),q=$("#sell-all-orders").DataTable({bFilter:!1,bInfo:!1,lengthChange:!1,aoColumnDefs:[{orderable:!1,aTargets:["_all"]}],order:[],scrollY:"400px",scrollCollapse:!0,paging:!1,columns:[{data:"price",className:"color-sell",render:$.fn.dataTable.render.ellipsis()},{data:"crea",render:$.fn.dataTable.render.ellipsis()},{data:"cbd",render:$.fn.dataTable.render.ellipsis()}],fnCreatedRow:function(b,a,c){$(b).click(function(){n(a,"buy")})}}),
v=$("#user-orders").DataTable({bFilter:!1,bInfo:!1,lengthChange:!1,aoColumnDefs:[{orderable:!1,aTargets:["_all"]}],order:[],scrollY:"534px",scrollCollapse:!0,paging:!1,columns:[{data:"date"},{data:"expiration"},{data:"type",render:function(b,a,c,d){return"buy"===b.toLowerCase()?'<span class="color-buy">'+b.toUpperCase()+"</span>":'<span class="color-sell">'+b.toUpperCase()+"</span>"}},{data:"price"},{data:"crea"},{data:"cbd"},{data:"action",render:function(b,a,c,d){return'<div id="'+c.orderid+'" class="btn btn--sm"><span class="btn__text text__dark font-weight-bold"> '+
lang.BUTTON.CANCEL+"</span></a>"}}],fnCreatedRow:function(b,a,c){$("#"+a.orderid,b).click(function(){B(a.orderid)})}}),r=$("#market-history").DataTable({bFilter:!1,bInfo:!1,lengthChange:!1,aoColumnDefs:[{orderable:!1,aTargets:["_all"]}],order:[],scrollY:"200px",scrollCollapse:!0,paging:!1,columns:[{data:"date",render:$.fn.dataTable.render.ellipsis()},{data:"price",render:function(b,a,c,d){return"buy"===c.type.toLowerCase()?'<span class="color-buy">'+b+"</span>":'<span class="color-sell">'+b+"</span>"}},
{data:"crea",render:$.fn.dataTable.render.ellipsis()},{data:"cbd",render:$.fn.dataTable.render.ellipsis()}]}))}function y(b,a){g=b;t=a;z()}var d,x,p,w,m,q,v,r,f,g=null,t=null,h=new RpcWsClient("wss://nodes.creary.net");h.connect();h.on("ws.message",function(b,a){console.log("WS MSG",b,a)});creaEvents.on("crea.session.login",function(b,a){creaEvents.emit("crea.dom.ready");y(b,a);setTimeout(function(){console.log("session started");J();I(3E3)},500)});creaEvents.on("crea.session.update",function(b,a){y(b,
a)});$(window).on("beforeunload",function(){console.log("before unload event");h.close()})})();
