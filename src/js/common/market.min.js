(function(){function C(){e?(e.session=g,e.account=u,e.$forceUpdate()):e=new Vue({el:"#market-container",data:{lang:lang,session:g,account:u,recentTrades:[],ticker:{penultimate:null,latest:"0.000000",lowest_ask:"0.000000",highest_bid:"0.000000",percent_change:"0.000000",crea_volume:"0.000 CREA",cbd_volume:"0.000 CREA"},buyForm:{price:"0.000",amount:"0.000",total:"0.000"},sellForm:{price:"0.000",amount:"0.000",total:"0.000"}},methods:{parseAsset:Asset.parse,dateFromNow:function(a){return toLocaleDate(a).fromNow()},
priceFor:function(a,b){a=Asset.parse(a);b=Asset.parse(b);a=b.toFloat()/a.toFloat();return Asset.parse({amount:a,nai:b.asset.symbol})},clearOrderForm:function(a){a=a.toLowerCase();"buy"===a?(this.buyForm.price="0.000",this.buyForm.amount="0.000",this.buyForm.total="0.000"):(this.sellForm.price="0.000",this.sellForm.amount="0.000",this.sellForm.total="0.000")},onParseBuyForm:function(){this.buyForm.price=Asset.parse({amount:this.buyForm.price?parseFloat(this.buyForm.price)+1E-4:"0.000",nai:"cbd"}).toPlainString();
this.buyForm.amount=Asset.parse({amount:this.buyForm.amount?parseFloat(this.buyForm.amount)+1E-4:"0.000",nai:"cbd"}).toPlainString();isNaN(this.buyForm.price)||isNaN(this.buyForm.amount)?this.buyForm.total=Asset.parse({amount:parseFloat(this.buyForm.total)+1E-4,nai:"cbd"}).toPlainString():this.buyForm.total=Asset.parse({amount:parseFloat(this.buyForm.price*this.buyForm.amount)+1E-4,nai:"cbd"}).toPlainString()},inputBuy:function(a,b){b=b.toLowerCase();var c=a.which?a.which:a.keyCode;if(31<c&&(48>c||
57<c)&&46!==c)return cancelEventPropagation(a),!1;c=a.target.value;a=Asset.parse({amount:c,nai:"crea",exponent:3}).toPlainString();if(!isNaN(c)||!isNaN(a))switch(c=this.buyForm.amount,b){case "price":c&&(this.buyForm.total=Asset.parse({amount:(c*a).toString(),nai:"cbd",exponent:3}).toPlainString());break;case "amount":if(b=this.buyForm.price)this.buyForm.total=Asset.parse({amount:(a*b).toString(),nai:"cbd",exponent:3}).toPlainString();break;default:c&&(this.buyForm.price=Asset.parse({amount:(a/c).toString(),
nai:"cbd",exponent:3}).toPlainString())}return!0},onParseSellForm:function(){this.sellForm.price=Asset.parse({amount:this.sellForm.price?parseFloat(this.sellForm.price)+1E-4:"0.000",nai:"cbd"}).toPlainString();this.sellForm.amount=Asset.parse({amount:this.sellForm.amount?parseFloat(this.sellForm.amount)+1E-4:"0.000",nai:"cbd"}).toPlainString();isNaN(this.sellForm.price)||isNaN(this.sellForm.amount)?this.sellForm.total=Asset.parse({amount:parseFloat(this.sellForm.total)+1E-4,nai:"cbd"}).toPlainString():
this.sellForm.total=Asset.parse({amount:parseFloat(this.sellForm.price*this.sellForm.amount)+1E-4,nai:"cbd"}).toPlainString()},inputSell:function(a,b){b=b.toLowerCase();var c=a.which?a.which:a.keyCode;if(31<c&&(48>c||57<c)&&46!==c)return cancelEventPropagation(a),!1;a=a.target.value;c=Asset.parse({amount:a,nai:"crea",exponent:3}).toPlainString();if(!isNaN(a)||!isNaN(c))switch(c=this.sellForm.amount,b){case "price":c&&(this.sellForm.total=Asset.parse({amount:(c*a).toString(),nai:"cbd",exponent:3}).toPlainString());
break;case "amount":if(b=this.sellForm.price)this.sellForm.total=Asset.parse({amount:(a*b).toString(),nai:"cbd",exponent:3}).toPlainString();break;default:c&&(this.sellForm.price=Asset.parse({amount:(a/c).toString(),nai:"cbd",exponent:3}).toPlainString())}return!0},makeOrder:function(a){a=a.toLowerCase();var b=this;requireRoleKey(g?g.account.username:null,"active",function(c,d){var D=moment().add(28,"days").toDate();var E=randomNumber(0,4294967295);if("buy"===a){var m=b.buyForm.total+" CBD";var e=
b.buyForm.amount+" CREA"}else"sell"===a&&(m=b.sellForm.amount+" CREA",e=b.sellForm.total+" CBD");crea.broadcast.limitOrderCreate(c,d,E,m,e,!1,D,function(c,d){catchError(c)||(b.clearOrderForm(a),n(),updateUserSession())})})}}})}function p(a,b){b=b.toLowerCase();"buy"===b?(e.buyForm.price=a.price,e.buyForm.amount=a.crea,e.onParseBuyForm()):(e.sellForm.price=a.price,e.sellForm.amount=a.crea,e.onParseSellForm())}function F(a){requireRoleKey(g.account.username,"active",function(b){crea.broadcast.limitOrderCancel(b,
g.account.username,a,function(a,b){catchError(a)||(n(),updateUserSession())})})}function n(){g&&h.send({method:"condenser_api.get_open_orders",params:[g.account.username]},function(a,b){if(!catchError(a)){var c=function(a){var b=Asset.parse(a.sell_price.base),c=Asset.parse(a.sell_price.quote),d="CREA"===b.asset.symbol?"Sell":"Buy";return{date:toLocaleDate(a.created).format("MMM DD, YYYY H:mm:ss"),expiration:toLocaleDate(a.expiration).format("MMM DD, YYYY H:mm:ss"),type:d,price:"$"+Asset.parse({amount:("Buy"===
d?b.toFloat()/c.toFloat():c.toFloat()/b.toFloat())+1E-4,nai:"cbd"}).toPlainString(),crea:"Buy"===d?c.toFriendlyString():Asset.parse({amount:a.for_sale,nai:"crea"}).toFriendlyString(),cbd:"Buy"===d?Asset.parse({amount:a.for_sale,nai:"cbd"}).toFriendlyString():c.toFriendlyString(),action:"button",orderid:a.orderid}},d=[];b.forEach(function(a){d.push(c(a))});d.sort(function(a,b){return(new Date(b.date)).getTime()-(new Date(a.date)).getTime()});v.clear();v.rows.add(d).draw()}})}function G(a,b){h.send({method:"market_history_api.get_ticker",
params:{}},function(c,d){c?console.error("Error getting ticker",c):(d.latest=Asset.parse({amount:d.latest,nai:"cbd",exponent:6}).toPlainString(),d.lowest_ask=a.toPlainString(),d.highest_bid=b.toPlainString(),d.percent_change=parseFloat(d.percent_change).toFixed(3),d.penultimate=e.ticker.penultimate,e.ticker.latest!==d.latest&&(d.penultimate=e.ticker.latest),e.ticker=d,e.$forceUpdate())})}function x(){h.send({method:"condenser_api.get_order_book",params:[100]},function(a,b){if(!catchError(a)){var c=
[],d=[];a=mixToArray(q.rows().data());var e=mixToArray(l.rows().data()),f=function(a){return{price:a.order_price,crea:a.crea,cbd:a.cbd,total_cbd:a.total_cbd}},m=0,g=0;b.bids.forEach(function(a,b){a.order_price=Asset.parse({amount:a.real_price,nai:"cbd",exponent:6}).toPlainString();a.crea=Asset.parse({amount:a.crea,nai:"crea"}).toPlainString();a.cbd=Asset.parse({amount:a.cbd,nai:"cbd"}).toPlainString();m+=parseFloat(a.cbd);a.total_cbd=Asset.parse({amount:m,nai:"cbd"}).toPlainString();c.push(f(a))});
c.sort(function(a,b){return b.price-a.price});isEqual(a,c)||(q.clear(),w.clear(),q.rows.add(c).draw(),w.rows.add(c).draw());b.asks.forEach(function(a,b){a.order_price=Asset.parse({amount:a.real_price,nai:"cbd",exponent:6}).toPlainString();a.crea=Asset.parse({amount:a.crea,nai:"crea"}).toPlainString();a.cbd=Asset.parse({amount:a.cbd,nai:"cbd"}).toPlainString();g+=parseFloat(a.cbd);a.total_cbd=Asset.parse({amount:g,nai:"cbd"}).toPlainString();d.push(f(a))});d.sort(function(a,b){return b.price-a.price});
isEqual(e,d)||(l.clear(),r.clear(),l.rows.add(d).draw(),r.rows.add(d).draw(),b=$(l.table().node()).parent(),b.scrollTop(b.get(0).scrollHeight),b=$(r.table().node()).parent(),b.scrollTop(b.get(0).scrollHeight))}})}function H(a,b){a&&$("[buy-last-price]").html(a);b&&$("[sell-last-price]").html(b)}function y(){h.send({method:"market_history_api.get_recent_trades",params:{limit:100}},function(a,b){if(a)console.error("Error getting recent trades",a);else{var c=[],d,e,f=moment(),g=moment().subtract(1,"day"),
h,l;b.trades.sort(function(a,b){return toLocaleDate(b.date).valueOf()-toLocaleDate(a.date).valueOf()});var n=[];b.trades.forEach(function(a){var b=toLocaleDate(a.date);a.date=b.fromNow();var k=Asset.parse(a.current_pays),m=Asset.parse(a.open_pays);a.current_pays=k.toPlainString();a.open_pays=m.toPlainString();a.cbd="CBD"===k.asset.symbol?a.current_pays:a.open_pays;a.crea="CBD"===k.asset.symbol?a.open_pays:a.current_pays;a.type="CBD"===k.asset.symbol?"buy":"sell";k=Asset.parse({amount:"CBD"===k.asset.symbol?
a.current_pays/a.open_pays:a.open_pays/a.current_pays,nai:"cbd",exponent:6});a.price=k.toPlainString();b.isBetween(g,f)&&(h=h?k.isLT(h)?k.clone():h:k.clone(),l=l?k.isGT(l)?k.clone():l:k.clone(),n.push(k.clone()));c.push(a);"sell"!==a.type||d||(d=a.price);"buy"!==a.type||e||(e=a.price)});G(h,l);a=mixToArray(t.rows().data());isEqual(a,c)||(t.clear(),t.rows.add(c).draw());H(d,e)}})}function z(){var a=moment();a={method:"market_history_api.get_market_history",params:{bucket_seconds:86400,end:a.format("YYYY-MM-DD[T]H:mm:ss"),
start:a.subtract(1,"months").format("YYYY-MM-DD[T]H:mm:ss")}};h.send(a,function(a,c){if(a)console.error("Fail getting chart data",a);else{var b=[];c.buckets.forEach(function(a){var c=Asset.parse({amount:a.non_crea.high,nai:"cbd"}).toFloat(),d=Asset.parse({amount:a.non_crea.low,nai:"cbd"}).toFloat();a={date:toLocaleDate(a.open).format("DD-MM-YYYY H:mm"),open:Asset.parse({amount:a.non_crea.open,nai:"cbd"}).toFloat(),high:c>d?c:d,low:d>c?c:d,close:Asset.parse({amount:a.non_crea.close,nai:"cbd"}).toFloat()};
b.push(a)});isEqual(f?f.data:[],b)||I(b)}})}function J(a,b){if(b||void 0===b)n(),x(),y(),z();a&&setInterval(function(){n();x();y();z()},a)}function I(a){if(!f){am4core.useTheme(am4themes_animated);f=am4core.create("market-chart",am4charts.XYChart);f.paddingRight=20;f.dateFormatter.inputDateFormat="dd-MM-yyyy HH:mm";f.xAxes.push(new am4charts.DateAxis).renderer.grid.template.location=0;f.yAxes.push(new am4charts.ValueAxis).tooltip.disabled=!0;var b=f.series.push(new am4charts.CandlestickSeries);b.dataFields.dateX=
"date";b.dataFields.valueY="close";b.dataFields.openValueY="open";b.dataFields.lowValueY="low";b.dataFields.highValueY="high";b.simplifiedProcessing=!0;b.tooltipText="Open: ${openValueY.value}\nLow: ${lowValueY.value}\nHigh: ${highValueY.value}\nClose: ${valueY.value}";b.riseFromOpenState.properties.fill=am4core.color("#25D77C");b.dropFromOpenState.properties.fill=am4core.color("#ff5766");b.riseFromOpenState.properties.stroke=am4core.color("#25D77C");b.dropFromOpenState.properties.stroke=am4core.color("#ff5766");
f.cursor=new am4charts.XYCursor;b=f.series.push(new am4charts.LineSeries);b.dataFields.dateX="date";b.dataFields.valueY="close";b.defaultState.properties.visible=!1;b.hiddenInLegend=!0;b.fillOpacity=.5;b.strokeOpacity=.5;var c=new am4charts.XYChartScrollbar;c.series.push(b);f.scrollbarX=c}f.data=a}function K(){A||(A=!0,$.fn.dataTable.render.ellipsis=function(){return function(a,b,c){return"display"===b&&10<a.length?a.substr(0,10)+"\u2026":a}},q=$("#buy-orders").DataTable({bFilter:!1,bInfo:!1,aoColumnDefs:[{orderable:!1,
aTargets:["_all"]}],order:[],scrollY:"250px",scrollCollapse:!0,paging:!1,columns:[{data:"price",className:"color-buy",render:$.fn.dataTable.render.ellipsis()},{data:"crea",render:$.fn.dataTable.render.ellipsis()},{data:"cbd",render:$.fn.dataTable.render.ellipsis()}],fnCreatedRow:function(a,b,c){$(a).click(function(){p(b,"sell")})}}),w=$("#buy-orders-all").DataTable({bFilter:!1,bInfo:!1,lengthChange:!1,aoColumnDefs:[{orderable:!1,aTargets:["_all"]}],order:[],scrollY:"400px",scrollCollapse:!0,paging:!1,
columns:[{data:"price",className:"color-buy",render:$.fn.dataTable.render.ellipsis()},{data:"crea",render:$.fn.dataTable.render.ellipsis()},{data:"cbd",render:$.fn.dataTable.render.ellipsis()}],fnCreatedRow:function(a,b,c){$(a).click(function(){p(b,"sell")})}}),l=$("#sell-orders").DataTable({bFilter:!1,bInfo:!1,lengthChange:!1,aoColumnDefs:[{orderable:!1,aTargets:["_all"]}],order:[],scrollY:"250px",scrollCollapse:!0,paging:!1,columns:[{data:"price",className:"color-sell",render:$.fn.dataTable.render.ellipsis()},
{data:"crea",render:$.fn.dataTable.render.ellipsis()},{data:"cbd",render:$.fn.dataTable.render.ellipsis()}],fnCreatedRow:function(a,b,c){$(a).click(function(){p(b,"buy")})}}),r=$("#sell-all-orders").DataTable({bFilter:!1,bInfo:!1,lengthChange:!1,aoColumnDefs:[{orderable:!1,aTargets:["_all"]}],order:[],scrollY:"400px",scrollCollapse:!0,paging:!1,columns:[{data:"price",className:"color-sell",render:$.fn.dataTable.render.ellipsis()},{data:"crea",render:$.fn.dataTable.render.ellipsis()},{data:"cbd",render:$.fn.dataTable.render.ellipsis()}],
fnCreatedRow:function(a,b,c){$(a).click(function(){p(b,"buy")})}}),v=$("#user-orders").DataTable({bFilter:!1,bInfo:!1,lengthChange:!1,aoColumnDefs:[{orderable:!1,aTargets:["_all"]}],order:[],scrollY:"534px",scrollCollapse:!0,paging:!1,columns:[{data:"date"},{data:"expiration"},{data:"type",render:function(a,b,c,d){return"buy"===a.toLowerCase()?'<span class="color-buy">'+a.toUpperCase()+"</span>":'<span class="color-sell">'+a.toUpperCase()+"</span>"}},{data:"price"},{data:"crea"},{data:"cbd"},{data:"action",
render:function(a,b,c,d){return'<div id="'+c.orderid+'" class="btn btn--sm"><span class="btn__text text__dark font-weight-bold"> '+lang.BUTTON.CANCEL+"</span></a>"}}],fnCreatedRow:function(a,b,c){$("#"+b.orderid,a).click(function(){F(b.orderid)})}}),t=$("#market-history").DataTable({bFilter:!1,bInfo:!1,lengthChange:!1,aoColumnDefs:[{orderable:!1,aTargets:["_all"]}],order:[],scrollY:"200px",scrollCollapse:!0,paging:!1,columns:[{data:"date",render:$.fn.dataTable.render.ellipsis()},{data:"price",render:function(a,
b,c,d){return"buy"===c.type.toLowerCase()?'<span class="color-buy">'+a+"</span>":'<span class="color-sell">'+a+"</span>"}},{data:"crea",render:$.fn.dataTable.render.ellipsis()},{data:"cbd",render:$.fn.dataTable.render.ellipsis()}]}))}function B(a,b){g=a;u=b;C()}var e,A,q,w,l,r,v,t,f,g=null,u=null,h=new RpcWsClient("wss://supportnodes.creary.net");h.connect();h.on("ws.message",function(a,b){console.log("WS MSG",a,b)});creaEvents.on("crea.session.login",function(a,b){creaEvents.emit("crea.dom.ready");
B(a,b);setTimeout(function(){console.log("session started");K();J(3E3)},500)});creaEvents.on("crea.session.update",function(a,b){B(a,b)});$(window).on("beforeunload",function(){console.log("before unload event");h.close()})})();
