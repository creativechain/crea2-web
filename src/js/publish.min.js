"use strict";var publishContainer;var postUploads={};(function(){var g,f;function e(x){var n={price:0,currency:"CREA"};var s={};var p=x?License.fromFlag(x.metadata.license):License.fromFlag(LICENSE.NO_LICENSE.flag);if(x){var w=x.metadata.featuredImage;s=w.url?w:mfi?{url:w}:s}publishContainer=new Vue({el:"#publish-container",data:{lang:lang,session:g,LICENSE:LICENSE,CONSTANTS:CONSTANTS,step:1,editablePost:x,bodyElements:x?x.body:[],tags:[],uploadedFiles:[],updatingIndex:-1,editor:{editing:false,show:false},featuredImage:s,title:x?x.title:null,description:x?x.metadata.description:"",adult:x?x.metadata.adult:false,downloadFile:n,publicDomain:p.has(LICENSE.FREE_CONTENT.flag)?LICENSE.FREE_CONTENT.flag:LICENSE.NO_LICENSE.flag,share:p.has(LICENSE.SHARE_ALIKE.flag)?LICENSE.SHARE_ALIKE.flag:p.has(LICENSE.NON_DERIVATES.flag)?LICENSE.NON_DERIVATES.flag:LICENSE.NO_LICENSE.flag,commercial:p.has(LICENSE.NON_COMMERCIAL.flag)?LICENSE.NON_COMMERCIAL.flag:LICENSE.NO_LICENSE.flag,noLicense:p.has(LICENSE.NON_PERMISSION.flag)?LICENSE.NON_PERMISSION.flag:LICENSE.NO_LICENSE.flag,showEditor:false,tagsConfig:{init:false,addedEvents:false},error:null},mounted:function j(){},updated:function q(){console.log("updating");if(this.step!==2){this.tagsConfig.init=false;this.tagsConfig.addedEvents=false}if(this.step===2){var B=$("#publish-tags");var C=this;if(!this.tagsConfig.init){B.tagsinput({maxTags:CONSTANTS.MAX_TAGS,maxChars:CONSTANTS.TEXT_MAX_SIZE.TAG,delimiter:" "});this.tagsConfig.init=true}if(!this.tagsConfig.addedEvents){B.on("beforeItemAdd",function(D){if(!C.tags.includes(D.item)){C.tags.push(D.item)}});B.on("itemRemoved",function(E){var D=C.tags.indexOf(E.item);if(D>-1){C.tags.splice(D,1)}});this.tagsConfig.addedEvents=true;if(x){var A=x.metadata.tags;A.forEach(function(D){B.tagsinput("add",D)})}}if(C.tags.length>0){C.tags.forEach(function(D){B.tagsinput("add",D)})}}},methods:{getLicense:function k(){var A;if(this.noLicense===LICENSE.NON_PERMISSION.flag){A=License.fromFlag(this.noLicense)}else{if(this.publicDomain===LICENSE.FREE_CONTENT.flag){A=License.fromFlag(this.publicDomain)}else{A=LICENSE.CREATIVE_COMMONS.flag|LICENSE.ATTRIBUTION.flag|this.share|this.commercial;A=License.fromFlag(A)}}return A},toStep:function o(A){if(!this.editor.show&&this.step>A){this.step=A}},nextStep:function l(){var A=this;if(!this.editor.show){switch(this.step){case 1:this.bodyElements=cleanArray(this.bodyElements);this.error=this.bodyElements.length>0?null:this.lang.PUBLISH.NO_ELEMENTS_ERROR;break;case 2:if(!this.featuredImage.hash||!this.title||this.tags.length===0){this.error=this.lang.PUBLISH.NO_TITLE_TAG_OR_IMAGE}else{this.error=null}break;case 3:if((this.editablePost&&this.editablePost.download.size)&&!this.downloadFile.size){this.error=String.format(this.lang.PUBLISH.RELOAD_DOWNLOAD_FILE,this.editablePost.download.size.name)}else{this.error=null}break}if(!this.error){this.step+=1}}},loadFile:function m(B){if(!this.editor.show){var A=this.$refs.publishInputFile;A.click()}},loadFeaturedImage:function y(B){var A=this.$refs.publishInputCover;A.click()},onInputDownloadFile:function v(E){var D=E.target.files;var C=this;if(D.length>0){globalLoading.show=true;var B=D[0];var A=CONSTANTS.FILE_MAX_SIZE.POST_BODY.DOWNLOAD;uploadToIpfs(B,A,function(G,F){globalLoading.show=false;if(!catchError(G)){F.resource=F.url;C.downloadFile=Object.assign(C.downloadFile,jsonify(jsonstring(F)))}})}},onLoadFile:function r(E){var D=this;var C=E.target.files;console.log("File loading",E);if(C.length>0){globalLoading.show=true;var B=C[0];var A=CONSTANTS.FILE_MAX_SIZE.POST_BODY[B.type.toUpperCase().split("/")[0]];console.log("file:",B,"MaxSize:",A);uploadToIpfs(B,A,function(H,F){globalLoading.show=false;if(H){D.error=H}else{D.bodyElements.push(F);postUploads[F.hash]=B;D.error=null;resizeImage(B,function(I){var J=CONSTANTS.FILE_MAX_SIZE.POST_PREVIEW[B.type.toUpperCase().split("/")[0]];postUploads[F.hash]={original:B,resized:I};if(F.type.indexOf("image/")>-1&&!D.featuredImage.hash){uploadToIpfs(I,J,function(L,K){if(!L){D.featuredImage=K;console.log("Featured image loaded!")}else{console.error(L,I)}})}});var G=D.$refs.publishInputFile;$(G).val("")}})}},onLoadFeaturedImage:function u(E){var D=this;var C=E.target.files;if(C.length>0){globalLoading.show=true;var B=C[0];var A=CONSTANTS.FILE_MAX_SIZE.POST_PREVIEW[B.type.toUpperCase().split("/")[0]];resizeImage(B,function(F){uploadToIpfs(F,A,function(H,G){globalLoading.show=false;if(!catchError(H)){D.featuredImage=G;postUploads[G.hash]=B;D.error=null}})})}},toggleEditor:function t(A){cancelEventPropagation(A);if(!this.editor.show){this.editor.show=!this.editor.show}},editorInput:function z(A){this.editor.editing=A.length>0},updateText:c,removeTitleEmojis:b,removeDescriptionEmojis:a,editText:d,removeElement:h,makePublication:i,humanFileSize:humanFileSize,stringFormat:String.format}})}function b(j){var k=j.target;publishContainer.title=removeEmojis(k.value)}function a(j){var k=j.target;publishContainer.description=removeEmojis(k.value)}function c(){var j=arguments.length>0&&arguments[0]!==undefined?arguments[0]:-1;var k=CKEDITOR.instances.editor;var l=k.getData();if(!l.isEmpty()){if(j>-1){publishContainer.bodyElements[j].value=l}else{publishContainer.bodyElements.push({value:l,type:"text/html"})}publishContainer.updatingIndex=-1;k.setData("");publishContainer.editor.editing=false;publishContainer.editor.show=false}}function d(j){console.log("Editing text",j);if(j>-1){publishContainer.editor.show=true;setTimeout(function(){var k=CKEDITOR.instances.editor;var l=publishContainer.bodyElements[j].value;k.setData(l);publishContainer.updatingIndex=j;publishContainer.editor.editing=true},500)}}function h(l){if(l>-1&&l<=publishContainer.bodyElements.length-1){var m=publishContainer.bodyElements[l];publishContainer.bodyElements.splice(l,1);if(m.type.includes("image/")){var n=postUploads[m.hash];if(n.resized.name===publishContainer.featuredImage.name&&n.resized.size===publishContainer.featuredImage.size){publishContainer.featuredImage={};delete postUploads[m.hash]}}if(!publishContainer.featuredImage.hash){for(var j=0;j<publishContainer.bodyElements.length;j++){var k=publishContainer.bodyElements[j];if(k.type.includes("image/")){var p=CONSTANTS.FILE_MAX_SIZE.POST_PREVIEW.IMAGE;var o=postUploads[k.hash];console.log("Selected new featured image",o.resized.name,k.hash);uploadToIpfs(o.resized,p,function(r,q){if(!r){console.log("Preview uploaded",q);publishContainer.featuredImage=q;console.log("Featured image loaded!")}else{console.error(r,o.resized)}});break}}}publishContainer.$forceUpdate()}}function i(j){cancelEventPropagation(j);var k=g.account.username;requireRoleKey(k,"posting",function(n){var v;globalLoading.show=true;var z=publishContainer.tags;var s=[];for(var u=0;u<z.length;u++){var w=normalizeTag(z[u]);if(!s.includes(w)){s.push(w)}}var q={description:publishContainer.description,tags:s,adult:publishContainer.adult,featuredImage:publishContainer.featuredImage,license:publishContainer.getLicense().getFlag()};var l=publishContainer.downloadFile;if(!l.price){l.price=0}l.price=Asset.parseString(l.price+" "+l.currency).toFriendlyString(null,false);if(!l.resource){l=""}var p=jsonstring(publishContainer.bodyElements);var r=publishContainer.title;var o=!!publishContainer.editablePost;var y=o?publishContainer.editablePost.permlink:toPermalink(r);var m=function(){if(o&&publishContainer.editablePost.metadata.tags){var A=publishContainer.editablePost.metadata.tags[0];if(A&&!q.tags.includes(A)){q.tags.unshift(A)}}var t=[];t.push(crea.broadcast.commentBuilder("",toPermalink(q.tags[0]),k,y,r,p,jsonstring(l),jsonstring(q)));switch(f.user.metadata.post_rewards){case"0":t.push(crea.broadcast.commentOptionsBuilder(k,y,"0.000 CBD",10000,true,true,[]));break;case"100":t.push(crea.broadcast.commentOptionsBuilder(k,y,"1000000.000 CBD",0,true,true,[]))}var x=[n];(v=crea.broadcast).sendOperations.apply(v,[x].concat(t,[function(D,B){if(!catchError(D)){console.log(B);var C={url:"/"+toPermalink(q.tags[0])+"/@"+g.account.username+"/"+y};showPost(C)}else{globalLoading.show=false}}]))};if(!o){crea.api.getDiscussion(k,y,function(x,t){console.log(x,t);if(!x){if(t.id!==0){catchError(lang.ERROR.PERMLINK_ALREADY_EXISTS);globalLoading.show=false}else{m()}}})}else{m()}})}creaEvents.on("crea.content.loaded",function(){var m=getParameterByName("edit");if(m){var l=m.split("/")[0];var j=m.split("/")[1];var k=Session.getAlive();if(k&&k.account.username===l){crea.api.getDiscussion(l,j,function(p,n){if(!catchError(p)){n=parsePost(n);var o=Asset.parse(n.download.price);n.download.price=parseFloat(o.toPlainString());n.download.currency=o.asset.symbol;e(n)}})}else{}}else{e()}});creaEvents.on("crea.session.login",function(k,j){g=k;publishContainer.session=k;publishContainer.$forceUpdate();f=j;creaEvents.emit("crea.dom.ready")})})();