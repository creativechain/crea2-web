"use strict";(function(){var g,f;var h;var i={};function e(z){var p={price:0,currency:"CREA"};var u={};var r=z?License.fromFlag(z.metadata.license):License.fromFlag(LICENSE.NO_LICENSE.flag);if(z){var y=z.metadata.featuredImage;u=y.url?y:mfi?{url:y}:u}h=new Vue({el:"#publish-container",data:{lang:lang,session:g,LICENSE:LICENSE,CONSTANTS:CONSTANTS,step:1,editablePost:z,bodyElements:z?z.body:[],tags:[],uploadedFiles:[],updatingIndex:-1,editor:{editing:false,show:false},featuredImage:u,title:z?z.title:null,description:z?z.metadata.description:"",adult:z?z.metadata.adult:false,downloadFile:p,publicDomain:r.has(LICENSE.FREE_CONTENT.flag)?LICENSE.FREE_CONTENT.flag:LICENSE.NO_LICENSE.flag,share:r.has(LICENSE.SHARE_ALIKE.flag)?LICENSE.SHARE_ALIKE.flag:r.has(LICENSE.NON_DERIVATES.flag)?LICENSE.NON_DERIVATES.flag:LICENSE.NO_LICENSE.flag,commercial:r.has(LICENSE.NON_COMMERCIAL.flag)?LICENSE.NON_COMMERCIAL.flag:LICENSE.NO_LICENSE.flag,noLicense:r.has(LICENSE.NON_PERMISSION.flag)?LICENSE.NON_PERMISSION.flag:LICENSE.NO_LICENSE.flag,showEditor:false,tagsConfig:{init:false,addedEvents:false},error:null},mounted:function l(){},updated:function s(){console.log("updating");if(this.step!==2){this.tagsConfig.init=false;this.tagsConfig.addedEvents=false}if(this.step===2){var D=$("#publish-tags");var E=this;if(!this.tagsConfig.init){D.tagsinput({maxTags:CONSTANTS.MAX_TAGS,maxChars:CONSTANTS.TEXT_MAX_SIZE.TAG,delimiter:" "});this.tagsConfig.init=true}if(!this.tagsConfig.addedEvents){D.on("beforeItemAdd",function(F){if(!E.tags.includes(F.item)){E.tags.push(F.item)}});D.on("itemRemoved",function(G){var F=E.tags.indexOf(G.item);if(F>-1){E.tags.splice(F,1)}});this.tagsConfig.addedEvents=true;if(z){var C=z.metadata.tags;C.forEach(function(F){D.tagsinput("add",F)})}}if(E.tags.length>0){E.tags.forEach(function(F){D.tagsinput("add",F)})}}},methods:{getLicense:function m(){var C;if(this.noLicense===LICENSE.NON_PERMISSION.flag){C=License.fromFlag(this.noLicense)}else{if(this.publicDomain===LICENSE.FREE_CONTENT.flag){C=License.fromFlag(this.publicDomain)}else{C=LICENSE.CREATIVE_COMMONS.flag|LICENSE.ATTRIBUTION.flag|this.share|this.commercial;C=License.fromFlag(C)}}return C},toStep:function q(C){if(!this.editor.show&&this.step>C){this.step=C}},nextStep:function n(){var C=this;if(!this.editor.show){switch(this.step){case 1:this.bodyElements=cleanArray(this.bodyElements);this.error=this.bodyElements.length>0?null:this.lang.PUBLISH.NO_ELEMENTS_ERROR;break;case 2:if(!this.featuredImage.hash||!this.title||this.tags.length===0){this.error=this.lang.PUBLISH.NO_TITLE_TAG_OR_IMAGE}else{this.error=null}break;case 3:if((this.editablePost&&this.editablePost.download.size)&&!this.downloadFile.size){this.error=String.format(this.lang.PUBLISH.RELOAD_DOWNLOAD_FILE,this.editablePost.download.size.name)}else{this.error=null}break}if(!this.error){this.step+=1}}},loadFile:function o(D){if(!this.editor.show){var C=this.$refs.publishInputFile;C.click()}},loadFeaturedImage:function A(D){var C=this.$refs.publishInputCover;C.click()},onInputDownloadFile:function x(G){var F=G.target.files;var E=this;if(F.length>0){globalLoading.show=true;var D=F[0];var C=CONSTANTS.FILE_MAX_SIZE.POST_BODY.DOWNLOAD;uploadToIpfs(D,C,function(I,H){globalLoading.show=false;if(!catchError(I)){H.resource=H.url;E.downloadFile=Object.assign(E.downloadFile,jsonify(jsonstring(H)))}})}},onLoadFile:function t(G){var F=this;var E=G.target.files;console.log("File loading",G);if(E.length>0){globalLoading.show=true;var D=E[0];var C=CONSTANTS.FILE_MAX_SIZE.POST_BODY[D.type.toUpperCase().split("/")[0]];console.log("file:",D,"MaxSize:",C);uploadToIpfs(D,C,function(J,H){globalLoading.show=false;if(J){F.error=J}else{F.bodyElements.push(H);i[H.hash]=D;F.error=null;resizeImage(D,function(K){var L=CONSTANTS.FILE_MAX_SIZE.POST_PREVIEW[D.type.toUpperCase().split("/")[0]];i[H.hash]={original:D,resized:K};if(H.type.indexOf("image/")>-1&&!F.featuredImage.hash){uploadToIpfs(K,L,function(N,M){if(!N){F.featuredImage=M;console.log("Featured image loaded!")}else{console.error(N,K)}})}});var I=F.$refs.publishInputFile;$(I).val("")}})}},onLoadFeaturedImage:function w(G){var F=this;var E=G.target.files;if(E.length>0){globalLoading.show=true;var D=E[0];var C=CONSTANTS.FILE_MAX_SIZE.POST_PREVIEW[D.type.toUpperCase().split("/")[0]];resizeImage(D,function(H){uploadToIpfs(H,C,function(J,I){globalLoading.show=false;if(!catchError(J)){F.featuredImage=I;i[I.hash]=D;F.error=null}})})}},toggleEditor:function v(C){cancelEventPropagation(C);if(!this.editor.show){this.editor.show=!this.editor.show}},editorInput:function B(C){this.editor.editing=C.length>0},updateText:c,removeTitleEmojis:b,removeDescriptionEmojis:a,editText:d,removeElement:j,makePublication:k,humanFileSize:humanFileSize,stringFormat:String.format}})}function b(l){var m=l.target;h.title=removeEmojis(m.value)}function a(l){var m=l.target;h.description=removeEmojis(m.value)}function c(){var l=arguments.length>0&&arguments[0]!==undefined?arguments[0]:-1;var m=CKEDITOR.instances.editor;var n=m.getData();if(!n.isEmpty()){if(l>-1){h.bodyElements[l].value=n}else{h.bodyElements.push({value:n,type:"text/html"})}h.updatingIndex=-1;m.setData("");h.editor.editing=false;h.editor.show=false}}function d(l){console.log("Editing text",l);if(l>-1){h.editor.show=true;setTimeout(function(){var m=CKEDITOR.instances.editor;var n=h.bodyElements[l].value;m.setData(n);h.updatingIndex=l;h.editor.editing=true},500)}}function j(n){if(n>-1&&n<=h.bodyElements.length-1){var o=h.bodyElements[n];h.bodyElements.splice(n,1);if(o.type.includes("image/")){var p=i[o.hash];if(p.resized.name===h.featuredImage.name&&p.resized.size===h.featuredImage.size){h.featuredImage={};delete i[o.hash]}}if(!h.featuredImage.hash){for(var l=0;l<h.bodyElements.length;l++){var m=h.bodyElements[l];if(m.type.includes("image/")){var r=CONSTANTS.FILE_MAX_SIZE.POST_PREVIEW.IMAGE;var q=i[m.hash];console.log("Selected new featured image",q.resized.name,m.hash);uploadToIpfs(q.resized,r,function(t,s){if(!t){console.log("Preview uploaded",s);h.featuredImage=s;console.log("Featured image loaded!")}else{console.error(t,q.resized)}});break}}}h.$forceUpdate()}}function k(l){cancelEventPropagation(l);var m=g.account.username;requireRoleKey(m,"posting",function(p){var y;globalLoading.show=true;var B=h.tags;var v=[];for(var w=0;w<B.length;w++){var z=normalizeTag(B[w]);if(!v.includes(z)){v.push(z)}}var s={description:h.description,tags:v,adult:h.adult,featuredImage:h.featuredImage,license:h.getLicense().getFlag()};var n=h.downloadFile;if(!n.price){n.price=0}n.price=Asset.parseString(n.price+" "+n.currency).toFriendlyString(null,false);if(!n.resource){n=""}var r=jsonstring(h.bodyElements);var u=h.title;var q=!!h.editablePost;var A=q?h.editablePost.permlink:toPermalink(u);var o=function(){if(q&&h.editablePost.metadata.tags){var C=h.editablePost.metadata.tags[0];if(C&&!s.tags.includes(C)){s.tags.unshift(C)}}var t=[];t.push(crea.broadcast.commentBuilder("",toPermalink(s.tags[0]),m,A,u,r,jsonstring(n),jsonstring(s)));switch(f.user.metadata.post_rewards){case"0":t.push(crea.broadcast.commentOptionsBuilder(m,A,"0.000 CBD",10000,true,true,[]));break;case"100":t.push(crea.broadcast.commentOptionsBuilder(m,A,"1000000.000 CBD",0,true,true,[]))}var x=[p];(y=crea.broadcast).sendOperations.apply(y,[x].concat(t,[function(F,D){if(!catchError(F)){console.log(D);var E={url:"/"+toPermalink(s.tags[0])+"/@"+g.account.username+"/"+A};showPost(E)}else{globalLoading.show=false}}]))};if(!q){crea.api.getDiscussion(m,A,function(x,t){console.log(x,t);if(!x){if(t.id!==0){catchError(lang.ERROR.PERMLINK_ALREADY_EXISTS);globalLoading.show=false}else{o()}}})}else{o()}})}creaEvents.on("crea.content.loaded",function(){var o=getParameterByName("edit");if(o){var n=o.split("/")[0];var l=o.split("/")[1];var m=Session.getAlive();if(m&&m.account.username===n){crea.api.getDiscussion(n,l,function(r,p){if(!catchError(r)){p=parsePost(p);var q=Asset.parse(p.download.price);p.download.price=parseFloat(q.toPlainString());p.download.currency=q.asset.symbol;e(p)}})}else{}}else{e()}});creaEvents.on("crea.session.login",function(m,l){g=m;h.session=m;h.$forceUpdate();f=l;creaEvents.emit("crea.dom.ready")})})();